var factory=function(t,e){var s=function(e,s){var i=this;i.field=t(e),i.el=null,i.json=null,i.items=[],i.selectedItem=null,i.list=t('<ul class="autocomplete-list" />'),i.lastSearch=null,i.options=s};s.defaults=(s.prototype={defaults:{minChars:2,markAsBold:!0,grouped:!1,externalItemsProp:"items",queryWithSearchTerm:!0,queryProperty:"q",queryParameters:{},method:"get",scrollOnFocus:"auto",maxItems:100,maxItemsOnMobile:3,mobileWidth:700,keyboardDelay:300,lastItemTemplate:null,closeOnSelect:!0,groupContentName:".autocomplete-items",groupTemplate:'<li class="autocomplete-group"><span class="autocomplete-group-header">{{title}}</span><ul class="autocomplete-items" /></li>',itemTemplate:'<li class="autocomplete-item">{{title}}</li>',showNoResults:!1,noResultsTemplate:'<li class="autocomplete-item">No results for {{title}}</li>',wrapClasses:"autocomplete"},init:function(){return this.defaults.templateMethod=this.template,this.settings=t.extend({},this.defaults,this.options),this.setupSettings(),this.setupMarkup(),this.setupEvents(),this},template:function(t,e){return t.replace(/{{\s*[\w]+\s*}}/g,(function(t){return e[t.substr(2,t.length-4)]}))},debounce:function(t,e,s){var i;return function(){var n=this,l=arguments,a=function(){i=null,s||t.apply(n,l)},o=s&&!i;clearTimeout(i),i=setTimeout(a,e),o&&t.apply(n,l)}},setupSettings:function(){"auto"==this.settings.scrollOnFocus&&(this.settings.scrollOnFocus=this.isTouchDevice()),this.settings.maxItemsOnLarge=this.settings.maxItems,e.innerWidth<this.settings.mobileWidth&&null!==this.settings.maxItemsOnMobile&&(this.settings.maxItems=Math.min(this.settings.maxItems,this.settings.maxItemsOnMobile)),this.settings.data?this.request=this.localRequest:this.request=this.remoteRequest,null!=this.settings.keyboardDelay&&(this.request=this.debounce(this.request,this.settings.keyboardDelay))},setupEvents:function(){this.el.on("keyup",".autocomplete-field",t.proxy(this.onKeyUp,this)),this.el.on("keydown",".autocomplete-field",t.proxy(this.onKeyDown,this)),this.el.on("mousedown",".autocomplete-item",t.proxy(this.onClickItem,this)),this.el.on("blur",".autocomplete-field",t.proxy(this.closeList,this));var s=this;t(e).resize(this.debounce((function(){e.innerWidth<s.settings.mobileWidth&&null!==s.settings.maxItemsOnMobile?s.settings.maxItems=Math.min(s.settings.maxItems,s.settings.maxItemsOnMobile):s.settings.maxItems=s.settings.maxItemsOnLarge}),250)),this.settings.scrollOnFocus&&this.field.on("focus",(function(){var s=t(this).offset().top;setTimeout((function(){e.scrollTo(0,s)}),0)}))},setupMarkup:function(){this.field.addClass("autocomplete-field"),this.field.attr("autocomplete","off"),this.field.wrap('<div class="'+this.settings.wrapClasses+'" />'),this.el=this.field.parent()},remoteRequest:function(e){this.field.trigger("beforerequest",[this,e]);var s={};if(t.extend(s,this.settings.queryParameters),this.settings.queryWithSearchTerm)s[this.settings.queryProperty]=e;else if(null!=this.cachedData)return this.json=this.cachedData,void this.onReceiveData();t.ajax({method:this.settings.method,url:this.settings.url,dataType:"json",data:s,success:t.proxy(this.beforeReceiveData,this)})},localRequest:function(t){this.settings.grouped?this.beforeReceiveData(this.matchLocalPatternGrouped(t)):this.beforeReceiveData(this.matchLocalPatternFlat(t))},matchLocalPatternFlat:function(t){return this.matchArray(t,this.settings.data)},matchLocalPatternGrouped:function(e){for(var s=t.extend(!0,[],this.settings.data),i=0;i<s.length;i++){var n=this.matchArray(e,s[i].data);0==n.length?(s.splice(i,1),i--):s[i].data=n}return s},matchArray:function(t,e){for(var s=[],i=0;i<e.length;i++)for(var n in e[i])if(e[i][n].toLowerCase&&e[i][n].toLowerCase().indexOf(t.toLowerCase())>-1||e[i][n]==t){s.push(e[i]);break}return s},itemAt:function(e){return null==e?t():this.el.find(".autocomplete-item").eq(e)},clickedItemAt:function(t){for(var e=0;e<this.displayedItems.length;e++)if(t==this.el.find(".autocomplete-item").eq(e).get(0))return e;return null},prevItem:function(){this.selectedItem--,this.selectedItem<0&&(this.selectedItem=null),this.markSelected(this.selectedItem)},nextItem:function(){null==this.selectedItem&&(this.selectedItem=-1),this.selectedItem++;var t=this.settings.lastItemTemplate?this.displayedItems.length:this.displayedItems.length-1;this.selectedItem>=t&&(this.selectedItem=t),this.markSelected(this.selectedItem)},markSelected:function(t){this.el.find(".active").removeClass("active"),this.itemAt(t).addClass("active")},markHitText:function(t,e){var s=e.split(" ");for(var i in t)if("string"==typeof t[i]&&"template"!=i){for(var n=[e],l=0;l<s.length;l++){var a=s[l].trim().replace(/[^a-รถ0-9]/gi,"");a.length>0&&n.push(a)}t[i]=t[i].replace(new RegExp("("+n.join("|")+")","gi"),"<strong>$1</strong>")}return t},renderGroups:function(){for(var e in this.list.remove(),this.list=t('<ul class="autocomplete-list" />'),this.displayedItems)this.list.append(this.settings.templateMethod(this.settings.groupTemplate,this.displayedItems[e]));this.el.append(this.list)},renderItemsInGroups:function(){for(var e=this.field.val(),s=0;s<this.displayedItems.length;s++)for(var i=this.el.find(this.settings.groupContentName).eq(s),n=0;n<this.displayedItems[s].data.length&&n<this.settings.maxItems;n++){var l=t.extend({},this.displayedItems[s].data[n]);this.settings.markAsBold&&(l=this.markHitText(l,e)),i.append(this.settings.templateMethod(this.displayedItems[s].template||this.settings.itemTemplate,l))}},renderItemsFlat:function(){this.list.remove(),this.list=t('<ul class="autocomplete-list" />');for(var e=this.field.val(),s=0;s<this.displayedItems.length&&s<this.settings.maxItems;s++){var i=t.extend({},this.displayedItems[s]);this.settings.markAsBold&&(i=this.markHitText(i,e)),this.list.append(this.settings.templateMethod(this.displayedItems[s].template||this.settings.itemTemplate,i))}this.el.append(this.list)},renderLastItem:function(){this.list.append(this.settings.templateMethod(this.settings.lastItemTemplate,{title:this.field.val()}))},renderNoResults:function(){this.list.append(this.settings.templateMethod(this.settings.noResultsTemplate,{title:this.field.val()}))},closeList:function(){t("html").off("click"),this.list.remove(),this.selectedItem=null},getItemsFromGroups:function(){var t=[];for(var e in this.displayedItems)for(var s=0;s<this.displayedItems[e].data.length;s++)s<this.settings.maxItems&&t.push(this.displayedItems[e].data[s]);return t},valueHasChanged:function(){return this.field.val()!=this.lastSearch&&(this.lastSearch=this.field.val(),!0)},isTouchDevice:function(){return!!("ontouchstart"in e)},beforeReceiveData:function(t,e){var s=t[this.settings.externalItemsProp];this.json=s,this.settings.queryWithSearchTerm||(this.cachedData=s,this.jsonLower=this.lowercaseAll(s)),this.field.trigger("receivedata",[this,s,e]),this.onReceiveData()},onReceiveData:function(){this.selectedItem=null,this.settings.grouped?(this.renderGroups(),this.displayedItems=this.getItemsFromGroups(),this.renderItemsInGroups()):(this.settings.queryWithSearchTerm?this.displayedItems=this.json:this.displayedItems=this.filterItemsBySearchTerm(this.json,this.jsonLower),this.renderItemsFlat()),this.displayedItems.length||this.settings.showNoResults&&this.renderNoResults(),this.settings.lastItemTemplate&&this.renderLastItem(),t("html").one("click",t.proxy(this.closeList,this))},onKeyUp:function(t){this.field.val().length>=this.settings.minChars&&this.valueHasChanged()&&this.request(this.field.val()),""==this.field.val()&&(this.lastSearch="",this.closeList())},onKeyDown:function(t){38==t.keyCode&&(t.preventDefault(),this.prevItem()),40==t.keyCode&&(t.preventDefault(),this.nextItem()),13==t.keyCode&&this.onPressEnter(t),27==t.keyCode&&(t.preventDefault(),this.closeList())},onClickItem:function(t){var e=this.clickedItemAt(t.currentTarget);this.onSelect(t.currentTarget,this.displayedItems[e])},onPressEnter:function(t){if(null===this.selectedItem)return!0;t.preventDefault(),this.onSelect(this.itemAt(this.selectedItem),this.displayedItems[this.selectedItem])},onSelect:function(t,e){this.settings.onSelect&&this.settings.onSelect.apply(this.field,[t,e]),this.lastSearch=this.field.val(),this.settings.closeOnSelect&&this.closeList()},lowercaseAll:function(t){for(var e=[],s=0;s<t.length;s++){item=t[s];var i={...item};i.title=i.title.toLowerCase(),e.push(i)}return e},filterItemsBySearchTerm:function(t,e){for(var s=this.field.val(),i=[],n=0;n<t.length;n++)itemLower=e[n],itemLower.title.indexOf(s)>-1&&(item=t[n],i.push(item));return i}}).defaults,t.fn.tinyAutocomplete=function(e){return this.each((function(){if(this.tinyAutocomplete)return t.extend(this.tinyAutocomplete.settings,e),this;var i=new s(this,e).init();this.tinyAutocomplete={settings:i.settings}}))}};"undefined"!=typeof exports?module.exports=factory:factory($,window);